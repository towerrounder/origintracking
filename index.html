<html>

<head>
    <meta charset="UTF-8">
    <style>
        tr>td:first-child {
            text-align: right;
            width: 120px;
            padding: 2px;
        }

        body * {
            font-family: Calibri, sans-serif;
            font-size: 11px;
        }
        h2 {
            font-size: 16px;
        }
    </style>
</head>

<body>
    <span>London Stock Exchange Summary Page URL</span><br>
    <input type="url" id="inURL" style="width:600px"><button id="btParse">Parse</button>
    <h2>Spread</h2>
    <i>Should be less than or equal to 3</i>
    <table>
        <tr>
            <td>Offer</td>
            <td>
                <input id="inOffer" type="text" />
                <i>What the sell at (always higher than the bid)</i>
            </td>
        </tr>
        <tr>
            <td>Bid</td>
            <td>
                <input id="inBid" type="text" />
                <i>What they buy at</i>
            </td>
        </tr>
        <tr>
            <td>Spread</td>
            <td>
                <input id="inSpread" readonly type="text" />
                <span id="iSpreadComment"></span>
            </td>
        </tr>
    </table>
    <h2>Net Debt Ratio</h2>
    <i>Should be less than or eual to 3</i>
    <table>
        <tr>
            <td>Net Debt</td>
            <td>
                <input id="inNetDebt" type="text" />
            </td>
        </tr>
        <tr>
            <td>Pre-tax Profit</td>
            <td>
                <input id="inPretaxProfit" type="text" />
            </td>
        </tr>
        <tr>
            <td>Debt Ratio</td>
            <td>
                <input id="inDebtRatio" readonly type="text" />
                <span id="iDebtRatioComment"></span>
            </td>
        </tr>
    </table>
    <h2>Valuation</h2>
    <i>The company should be less thatn 15 ratio profit to market cap</i>
    <table>
        <tr>
            <td>Market Cap.</td>
            <td>
                <input id="inMarketCap" type="text" />
            </td>
        </tr>
        <tr>
            <td>Market Ratio</td>
            <td>
                <input id="inMarketCapRatio" readonly type="text" />
                <span id="iMarketCapRatioComment"></span>
            </td>
        </tr>
    </table>
    <h2>Summary</h2>
    <span id="sSummary"></span>
    <script>
        var niceNumber = function (x) {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
        var fetchURL = function (url, callback) {
            var url = "https://allorigins.me/get?method=raw&url=" + encodeURIComponent(url) + "&callback=?";
            $.get(url, function (response) {
                callback(response);
            });
        };

        var calculate = function () {
            //Spread
            var offer = $inOffer.val();
            var bid = $inBid.val();
            var spread_difference = offer - bid;
            var spread_percentage = parseFloat(((spread_difference / offer) * 100)).toFixed(2);
            $inSpread.val(spread_percentage);
            var spread_answer = Math.round(spread_percentage) <= 3 ? "Yes" : "No";
            $iSpreadComment.text(spread_answer + ". The spread is " + spread_percentage + "%");

            //Debt to Profit Ratio
            var debt = $inNetDebt.val();
            var profit = $inPretaxProfit.val();
            var debt_proft_ratio = parseFloat(debt / profit).toFixed(2);
            $inDebtRatio.val(debt_proft_ratio);
            var debt_proft_answer = Math.round(debt_proft_ratio) <= 3 ? "Yes" : "No";
            $iDebtRatioComment.text(debt_proft_answer + ". The company had a pre-tax profit of £" + niceNumber(profit) + " and net debt of £" + niceNumber(debt) + " giving a debt to profit ratio of " + debt_proft_ratio);

            //Market Cap
            var marketcap = $inMarketCap.val();
            var market_profit_ratio = parseFloat(marketcap / profit).toFixed(2);
            $inMarketCapRatio.val(market_profit_ratio);
            var market_profit_answer = Math.round(market_profit_ratio) <= 15 ? "Yes" : "No";
            $iMarketCapRatioComment.text(market_profit_answer + ". The company had a pre-tax profit of £" + niceNumber(profit) + " and a market cap of £" + niceNumber(marketcap) + " giving a market cap to profit ratio of " + market_profit_ratio);

            //Summary
            var summary = "Spread - " + spread_answer + ": " + spread_percentage + ". ";
            summary += "Small Debt - " + debt_proft_answer + ": " + debt_proft_ratio + ". ";
            summary += "Undervalued - " + market_profit_answer + ": " + market_profit_ratio + ".";
            $sSummary.text(summary);
        };

        $inURL = $("#inURL");
        $btParse = $("#btParse");

        var $inBid = $("#inBid");
        var $inOffer = $("#inOffer");
        var $inSpread = $("#inSpread");
        var $iSpreadComment = $("#iSpreadComment");

        var $inNetDebt = $("#inNetDebt");
        var $inPretaxProfit = $("#inPretaxProfit");
        var $inDebtRatio = $("#inDebtRatio");
        var $iDebtRatioComment = $("#iDebtRatioComment");

        var $inMarketCap = $("#inMarketCap");
        var $inMarketCapRatio = $("#inMarketCapRatio");
        var $iMarketCapRatioComment = $("#iMarketCapRatioComment");

        var $sSummary = $("#sSummary");

        $btParse.on("click", function (event) {
            var lse_summary_url = $inURL.val();

            fetchURL(lse_summary_url, function (summary_response) {
                var $summary_page = $(summary_response);

                var hostname = $('<a>').prop('href', lse_summary_url).prop('hostname');
                var lse_fundamentals_url = hostname + $summary_page.find("a:contains('Fundamentals')").attr("href");
                //debug
                //lse_fundamentals_url = "https://www.londonstockexchange.com/exchange/prices/stocks/summary/fundamentals.html?fourWayKey=GB0009035741GBGBXSSQ3";

                var $trBidOffer = $summary_page.find("td:contains('Bid')").parent();
                var $tdBid = $trBidOffer.find("td:nth-child(2)");
                var bid = $tdBid.text();
                var $tdOffer = $trBidOffer.find("td:nth-child(4)");
                var offer = $tdOffer.text();
                $inBid.val(bid);
                $inOffer.val(offer);

                fetchURL(lse_fundamentals_url, function (fundamentals_response) {
                    var $fundamentals_page = $(fundamentals_response);

                    var $trProf = $fundamentals_page.find("td:contains('Profit Before Tax')").parent();
                    var $tdProf = $trProf.find("td:last-child");
                    var prof = parseFloat($tdProf.text()) * 1000000;

                    var $trLiabilities = $fundamentals_page.find("td:contains('Total Liabilities')").parent();
                    var $tdLiabilities = $trLiabilities.find("td:last-child");
                    var liabilities = parseFloat($tdLiabilities.text()) * 1000000;

                    var $trMarketCap = $fundamentals_page.find("td:contains('Security market cap')").parent();
                    var $tdMarketCap = $trMarketCap.find("td:last-child");
                    var marketCap = parseFloat($tdMarketCap.text()) * 1000000;

                    $inPretaxProfit.val(prof);
                    $inNetDebt.val(liabilities);
                    $inMarketCap.val(marketCap);

                    calculate();
                });
            });
        });

        $("input[type='text']").on("input", calculate);

    </script>
</body>

</html>
